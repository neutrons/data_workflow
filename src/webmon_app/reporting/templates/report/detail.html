{% extends "report/base_instrument.html" %}

{% block title %}{{ instrument }} Run {{ run_object.run_number }}{% endblock %}
{% block banner %}{{ instrument }} Run {{ run_object.run_number }}{% endblock %}
{% block extra_files_header %}
<link rel="stylesheet" type="text/css" href="/static/thirdparty/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/static/thirdparty/cssmenu/styles.css" />
<script language="javascript" type="text/javascript" src="/static/thirdparty/jquery-3.7.1.min.js"></script>
<script language="javascript" type="text/javascript" src="/static/thirdparty/mustache.js-master/mustache.min.js"></script>
<link rel="stylesheet" type="text/css" href="/static/1d_plot/spectrum.css" />
<link rel="stylesheet" type="text/css" href="/static/1d_plot/1d_plots_v2.css" />
<link rel="stylesheet" type="text/css" href="/static/1d_plot/appstyles.css" />
{% endblock %}

{% block header %}
<script language="javascript" type="text/javascript" src="/static/thirdparty/jquery.sparkline.min.js"></script>
<script language="javascript" type="text/javascript" src="/static/thirdparty/d3.v3/d3.v3.min.js"></script>
<script language="javascript" type="text/javascript" src="/static/live_update.js"></script>
<script language="javascript" type="text/javascript" src="/static/bar_chart.js"></script>

<link rel="stylesheet" media="all" href="/static/bar_chart.css" />
<link rel="stylesheet" type="text/css" href="/static/thirdparty/flaticon/flaticon.css">
<div id="dialog-confirm" title="Submit for post-processing" style="display:none">
   <p><span class="ui-icon ui-icon-alert" style="float: left"></span>
   Confirm submission?</p>
</div>
<script>
    function confirmDialog(action) {
        $( "#dialog-confirm" ).dialog({
            resizable: false,
            modal: true,
            buttons: {
                "Submit": function() {
                    window.location.href = action;
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                        }
                    }
        });
    };

{% if html_data %}
    // --- NEW DYNAMIC PLOTLY LOADER SCRIPT ---
    var loadedPlotlyScriptUrls = new Set();
    var defaultPlotlyVersion = '2.9.0';
    var plotlyBaseUrl = '/static/thirdparty/';
    var plotlyV2ScriptPath = plotlyBaseUrl + 'plotly-2.9.0.min.js';
    var plotlyV3ScriptPath = plotlyBaseUrl + 'plotly-3.0.1.min.js';

    function insertPlotHtml(plotHtml) {
        var graphContainer = $('#graph');
        if (graphContainer.length === 0) {
            console.error("#graph container not found in DOM for plot insertion.");
            return;
        }
        graphContainer.html(plotHtml);
        console.log("Plot HTML inserted into #graph.");
    }

    function loadPlotlyScriptAndRender(requiredVersion, plotHtmlToRender) {
        if (!requiredVersion || typeof requiredVersion !== 'string' || requiredVersion.trim() === '') {
            console.warn("Plotly version requirement is missing or invalid. Using default:", defaultPlotlyVersion);
            requiredVersion = defaultPlotlyVersion;
        }

        let scriptUrlToLoad = plotlyV2ScriptPath;
        if (requiredVersion.trim().startsWith('3.')) {
             scriptUrlToLoad = plotlyV3ScriptPath;
        }

        console.log("Plotly.js version required by plot data:", requiredVersion, "-> Mapped to script URL:", scriptUrlToLoad);

        if (loadedPlotlyScriptUrls.has(scriptUrlToLoad)) {
            console.log("Required Plotly script already loaded:", scriptUrlToLoad);
            insertPlotHtml(plotHtmlToRender);
            return;
        }

        console.log("Attempting to load Plotly.js from:", scriptUrlToLoad);
        var script = document.createElement('script');
        script.src = scriptUrlToLoad;
        script.async = false;
        script.onload = function() {
            console.log("Successfully loaded Plotly script:", scriptUrlToLoad);
            loadedPlotlyScriptUrls.add(scriptUrlToLoad);
            insertPlotHtml(plotHtmlToRender);
        };
        script.onerror = function() {
            console.error("CRITICAL ERROR: Failed to load Plotly script:", scriptUrlToLoad);
            $('#graph').html('<p class="error" style="color:red; font-weight:bold;">Error: Could not load required plotting library. Plot cannot be displayed.</p>');
        };
        document.head.appendChild(script);
    }

    var currentPlotHtml = '';
    function get_plot_update() {
        $.ajax({
            type: "GET",
            url: "{{ update_url }}",
            success: function(newPlotHtml) {
                if (currentPlotHtml.localeCompare(newPlotHtml) !== 0) {
                    currentPlotHtml = newPlotHtml;
                    console.log("New plot HTML received from server. Determining Plotly.js version requirement...");

                    var tempDiv = $('<div>').html(newPlotHtml);
                    var plotGraphDiv = tempDiv.find('div.plotly-graph-div');
                    var requiredVersion = null;

                    if (plotGraphDiv.length > 0 && plotGraphDiv.attr('plotlyjs-version')) {
                        requiredVersion = String(plotGraphDiv.attr('plotlyjs-version'));
                        console.log("Extracted 'plotlyjs-version' from plot div:", requiredVersion);
                    } else {
                        console.log("No 'plotlyjs-version' attribute found on the main plot div. Will use default.");
                        requiredVersion = defaultPlotlyVersion;
                    }

                    tempDiv.remove();

                    loadPlotlyScriptAndRender(requiredVersion, newPlotHtml);
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Failed to fetch plot update from {{ update_url }}:", textStatus, errorThrown);
                $('#graph').html('<p class="error" style="color:red;">Failed to load plot data. Please try again later.</p>');
            },
            dataType: "html",
            timeout: 25000
        });
    }

    get_plot_update();
    setInterval(get_plot_update, 60000);

{% elif plot_data %}
    console.log("Rendering plot from 'plot_data' context (likely non-LiveData).");

    if (!loadedPlotlyScriptUrls.has(plotlyV2ScriptPath)) {
        loadPlotlyScriptAndRender(defaultPlotlyVersion, '');
    }

    var plots = [];

    var anchor = "graph";
    var plot_options = {
      color: "#0077cc",
      log_scale_x: false,
      log_scale_y: true,
      grid: false,
      x_label: "{{ plot_label_x }}",
      y_label: "{{ plot_label_y }}",
      title: '',
      x_label_align: "center",
      y_label_align: "center",
      title_label_align: "center",
      allow_region_mode: false,
      predetermined_region: []
    }

      var dim = 20;
      var raw_data = {{ plot_data }};
      var step;
      var qx = [parseFloat(-2.5)];

      step = parseFloat(6) / dim;
      for (var i = 0; i < dim - 1; i++) {
            qx.push(qx[i] + step);
      }
    $(function() {
      var name = "{{ instrument }}_{{ run_object.run_number }}";
      var plot = new Plot_1d(raw_data, anchor, plot_options, name);
      plots.push(plot);
    });
{% endif %}
</script>

{% endblock %}

{% block summary %}
  <span style='float:right'>{% if prev_url %}<a href='{{ prev_url|safe }}'>previous</a>{% else %}previous{% endif %} | {% if next_url %}<a href='{{ next_url|safe }}'>next</a>{% else %}next{% endif %}</span>
  <br><br>
  {% if no_icat_info %}
  {% if run_number == run_object.run_number|stringformat:"i" %}
  <table class='info_display'>
    <tbody>
        <tr><td>Run title</td><td><b>{{ run_title|safe }}</b></td></tr>
    </tbody>
  </table>
  </p>
  {% endif %}
  <p>
  {{ no_icat_info }}
  <p>

  {% elif icat_info.title %}
  <table class='info_display'>
    <tbody>
        <tr><td>Run title</td><td><b>{{ icat_info.title|default:"unknown" }}</b></td></tr>
        <tr><td>Run start</td><td>{{ icat_info.startTime|default:"unknown" }}</td></tr>
        <tr><td>Run end</td><td>{{ icat_info.endTime|default:"unknown" }}</td></tr>
        <tr><td>Duration</td><td>{{ icat_info.duration|default:"0" }}</td></tr>
        <tr><td>Total counts</td><td>{{ icat_info.totalCounts|default:"0" }}</td></tr>
        <tr><td>Proton charge</td><td>{{ icat_info.protonCharge|default:"0" }}</td></tr>
    </tbody>
  </table>
  <p>
  {% endif %}

  {% if html_data %}
    {% if data_url %}
      Data access: <a href='{{ data_url }}'>download plot data points</a>
    {% endif %}
    <div id="graph" style="min-height: 400px;">
        <p>Loading plot...</p>
    </div>
  {% elif plot_data %}
    <p>
    <div class="graph main">
      <div class='graph cssmenu'></div>
      <div class="graph" id="graph"></div>
      <div class="graph user-console"></div>
    </div>
  {% endif %}

  <p>
  {% if not no_icat_info %}
  Data files:
  <ul>
  {%if icat_info.data_files %}
    {% for item in icat_info.data_files %}<li>{{ item|default:"unknown" }}</li>
    {% endfor %}
  {% else %}
    {{ run_object.file|default:"unknown" }}
  {% endif %}
  </ul>
  {%if icat_info.reduced_files %}
  <p>
  Reduced files:
  <ul>
    {% for item in icat_info.reduced_files %}<li>{{ item|default:"unknown" }}</li>
    {% endfor %}
  </ul>
  {% endif %}
  {% endif %}
{% endblock %}

{% block content %}
  <table class="message_table fixed_table">
    <thead>
      <tr>
        <th style="width: 170px;">Message</th>
        <th>Information</th>
        <th style="width: 90px;">Time</th>
      </tr>
    </thead>
    <tbody>
      {% for item in status %}
      <tr>
        <td>{{ item.queue_id.name|lower }}</td>
        {% if item.last_error %}<td class="error">{{ item.last_error.description }}</td>{% else %}<td>{{ item.last_info.description }}</td>{% endif %}
        <td>{{ item.created_on }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <br>
  {% if is_instrument_staff %}
  Submit for post-processing: <a href='javascript:void(0);' onClick="confirmDialog('catalog');">catalog</a>
  {% if reduce_url %} | <a href='javascript:void(0);' onClick="confirmDialog('reduce');">reduction</a> | <a href='javascript:void(0);' onClick="confirmDialog('postprocess');">all post-processing</a>{% endif %}
  {% if reduction_setup_url %} | <a href='{{ reduction_setup_url }}'>setup</a>{% endif %}
  {% endif %}
{% endblock %}

{% block extra_files_footer %}
  {% if plot_data %}
  <script language="javascript" type="text/javascript" src="/static/1d_plot/1d_plots_v2.js"></script>
  <script language="javascript" type="text/javascript" src="/static/thirdparty/saveSvgAsPng.js"></script>
  <script language="javascript" type="text/javascript" src="/static/1d_plot/spectrum.js"></script>
  <script language="javascript" type="text/javascript" src="/static/1d_plot/mustachetemplates.js"></script>
  <script language="javascript" type="text/javascript" src="/static/1d_plot/appfunctions.js"></script>
  <script language="javascript" type="text/javascript" src="/static/thirdparty/cssmenu/script.js"></script>
  {% endif %}
{% endblock %}
